<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>HappyLifeEntitled</title>
    <!-- meta tags -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

	<!-- bootstrap css library -->
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<!-- navbar css -->
	<link rel="stylesheet" type="text/css" href="assets/styles/hle_navbar.css">
	<!-- map css -->

    <style>
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #btn-refresh {
        position:absolute;
        bottom:2%;
        background-color: white;
        padding: 11px;

        border-radius: 2px;
        box-sizing: border-box;
        -moz-box-sizing: border-box;

        outline: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        alignment-baseline:central;
        width:80px;
        height: 35px;
        left:5%;
        text-align:center;
        text-decoration:none;
        margin:0px auto;

        color: black;
      }


      #btn-refresh:hover {
         background-color: lightgray;
         cursor: pointer;
      }
    </style>
  </head>
  <body>
  	<!-- navbar -->
	<div id="container-navbar" class="container-fluid">
		<nav class="navbar navbar-default">
			<div class="navbar-header">
				<button id="btn-home-mobile" type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#" aria-expanded="false" aria-controls="navbar">
					<span><a href="index.html"><img class="img-responsive" src="assets/images/home.png"></a></span>
				</button>
				<a class="navbar-brand" href="https://www.happylifeentitled.org">
					<img src="assets/images/logo.png" alt="HappyLifeEntitled">
				</a>
			</div>
			<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav navbar-right">
					<li><a href="index.html">HOME</a></li>
				</ul>
			</div>
		</nav>
	</div>

    <div id="map"></div>

    <!-- jquery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<!-- bootstrap js library -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

	<script>
		$(function() {
			var h = window.innerHeight;
			var navbar_height = $('#container-navbar').height();
			$('#map').css('height', h - navbar_height + 'px');

			$(window).resize(function(){
				window.location.reload(true);
			})

		});
	</script>
    <!-- geoLocation js -->
    <script>
    	var geo_info = new Object();
    	var map = document.getElementById('map');

    	function getLocation() {
		    if (navigator.geolocation) {
		        navigator.geolocation.getCurrentPosition(showPosition, showError);
		    } else { 
		        map.innerHTML = "Geolocation is not supported by this browser.";
		    }
		}

		function showPosition(position) {
			geo_info.lat = position.coords.latitude;
			geo_info.lng = position.coords.longitude;
		}

		function showError(error) {
		    switch(error.code) {
		        case error.PERMISSION_DENIED:
		            map.innerHTML = "User denied the request for Geolocation."
		            break;
		        case error.POSITION_UNAVAILABLE:
		            map.innerHTML = "Location information is unavailable."
		            break;
		        case error.TIMEOUT:
		            map.innerHTML = "The request to get user location timed out."
		            break;
		        case error.UNKNOWN_ERROR:
		            map.innerHTML = "An unknown error occurred."
		            break;
		    }
		}

		function getGeoInfo() {
			getLocation();
			return geo_info;
		}
    </script>

    <!-- google map -->
    <script>
	    function myButton(){
		    var btn = $('<div id="btn-refresh">Refresh</div>');
		    btn.bind('click', function(){
		        window.location.reload(true);
		    });
		    return btn[0];
		}

    	var obj = getGeoInfo();
    	obj.lat = 29.6451;
    	obj.lng = -82.369;
  	    function initMap() {
  	    	$.ajax({
				url: 'php/get_adjacent_treasure.php',
				type: 'POST',
				data: JSON.stringify(obj),
				success: function(response_data) {
					console.log(response_data.status);
					
					treasures = response_data.treasure_list;
					//console.log(user_info);
					var map = new google.maps.Map(document.getElementById('map'), {
		       	  		zoom: 16,
		          		center: {lat: parseFloat(obj.lat), 
		          			     lng: parseFloat(obj.lng)}
	          		});

	          		map.controls[google.maps.ControlPosition.TOP_CENTER].push(myButton());


		        	/* TODO: recent treasure locations */

		        	/* user icon */
		        	var user_marker = new google.maps.Marker({
		        		position: {lat: parseFloat(obj.lat), 
		          			       lng: parseFloat(obj.lng)},
		          		map: map
		        	});

		        	var locations = new Array();
		        	if (treasures != null && treasures.length > 0) {
			        	for(var i = 0; i < treasures.length; i++) {
			        		locations.push({lat: parseFloat(treasures[i].latitude), 
			        						lng: parseFloat(treasures[i].longitude)});
			        	}

			        	console.log(locations);

				        // Add some markers to the map.
				        // Note: The code uses the JavaScript Array.prototype.map() method to
				        // create an array of markers based on a given "locations" array.
				        // The map() method here has nothing to do with the Google Maps API.
				        var markers = locations.map(function(location, i) {
				          return new google.maps.Marker({
				            position: location,
				            label: 'X'
				          });
				        });

				        // Add a marker clusterer to manage the markers.
				        var markerCluster = new MarkerClusterer(map, markers,
				            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
				    } 
				},
				error: function(xhr, status, data) {
					console.log(xhr.responseText);
				}
			});
	    }
    	
    </script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAjF3k36s2YsoTTSu2eHizlEWv_1U6BcyI&callback=initMap">
    </script>
  </body>
</html>